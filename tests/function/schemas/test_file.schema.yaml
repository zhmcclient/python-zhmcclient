$schema: https://json-schema.org/draft/2020-12/schema
title: JSON schema for a zhmcclient function test file
definitions:
  zhmcclient_object:
    description: >-
      A zhmcclient resource or manager object, along with input parameters for
      creating it. Its parent resource objects are also defined, up to but
      excluding the zhmcclient.Client object.
    type: object
    additionalProperties: false
    required:
      - manager_attribute
    properties:
      manager_attribute:
        description: >-
          Name of the attribute on the parent zhmcclient resource object that
          represents the manager object for this resource object.
        type: string
      uri:
        description: >-
          Canonical URI of the resource object on the HMC.
          Required for zhmcclient resource objects; not permitted for zhmcclient
          manager objects.
        type: string
      name:
        description: >-
          Name of the resource object.
          Required for zhmcclient resource objects; not permitted for zhmcclient
          manager objects.
        type: string
      properties:
        description: >-
          Additional properties for creating the zhmcclient resource object.
          Optional for zhmcclient resource objects; not permitted for zhmcclient
          manager objects.
        type: object
        additionalProperties: false
        patternProperties:
          '^[a-zA-Z0-9\-]+$':
            description: Property name and value
            type:
              - string
              - number
              - integer
              - boolean
              - 'null'
              - object
              - array
      parent:
        $ref: '#/definitions/zhmcclient_object'
        description: >-
          Parent zhmcclient resource object of the resource or manager object.
          The chain of parents must go up to but not include the
          zhmcclient.Client object.
description: List of zhmcclient function testcases
type: array
items:
  description: A single zhmcclient function testcase
  type: object
  additionalProperties: false
  required:
    - name
    - description
    - zhmcclient_call
    - zhmcclient_result
  properties:
    name:
      description: 'Name of the testcase as recognized by pytest. Must be unique within the
        test file.'
      type: string
    description:
      description: Short description of the testcase
      type: string
    skip:
      description: >-
        If specified, this testcase is skipped, and the string is the skip message.
      type: string
    debug:
      description: >-
        Flag indicating that the interactive Python debugger should come up
        in this testcase.
      type: boolean
      default: false
    zhmcclient_call:
      description: >-
        The zhmcclient method to be called or zhmcclient property to be
        accessed in this testcase.
      type: object
      additionalProperties: false
      required:
        - target
      properties:
        target:
          $ref: '#/definitions/zhmcclient_object'
          description: >-
            Target zhmcclient resource or manager object against which the
            zhmcclient method is called or the zhmcclient property is accessed.
        attribute:
          description: >-
            Name of an attribute on the target resource object that has the
            zhmcclient method to be called or zhmcclient property to be
            accessed. If omitted, the target resource object has that
            method or property directly.
          type: string
        property:
          description: >-
            Name of the zhmcclient property to be accessed.
            Mutually exclusive with "method", and exactly one is required.
          type: string
        method:
          description: >-
            Name of the zhmcclient method to be called.
            Mutually exclusive with "property", and exactly one is required.
          type: string
        parameters:
          description: >-
            Parameters to be passed to the zhmcclient method.
            Required when "method" is specified.
          type: object
          additionalProperties: false
          patternProperties:
            '^[a-zA-Z0-9_]+$':
              description: Parameter name and value
              type:
                - string
                - number
                - integer
                - boolean
                - 'null'
                - object
                - array
    zhmcclient_result:
      description: >-
        The expected result of the zhmcclient method call or property access.
      type: object
      additionalProperties: false
      oneOf:
        - required:
            - return
        - required:
            - exception
      properties:
        return:
          description: >-
            Expected return value, if the method call or property access does
            not raise an exception.
            TODO: Support for zhmcclient objects as return values.
          type:
            - string
            - number
            - integer
            - boolean
            - 'null'
            - object
            - array
        exception:
          description: >-
            Expected exception data, if the method call or property access
            raises an exception.
          type: object
          additionalProperties: false
          required:
            - class
          properties:
            class:
              description: >-
                Python class name of the expected exception, without Python
                module path.
              type: string
            message_pattern:
              description: >-
                Regexp pattern for the expected exception message. Begin and end
                markers must be specified, if they should be considered.
                If omitted, the exception message is not validated.
              type: string
            attributes:
              description: >-
                Expected attributes of the exception.
                If omitted, the exception attributes are not validated.
              type: object
              additionalProperties: false
              patternProperties:
                '^[a-zA-Z0-9_]+$':
                  description: Attribute name and value.
                  type:
                    - string
                    - number
                    - integer
                    - boolean
                    - 'null'
                    - object
                    - array
    hmc_session:
      description: Parameters for creating a zhmcclient.Session object for the test.
      type: object
      additionalProperties: false
      required:
        - host
      properties:
        # Keep defaults in sync with the defaults set in conftest.py
        host:
          description: >-
            "host" parameter for the zhmcclient.Session object.
          type: string
        userid:
          description: >-
            "userid" parameter for the zhmcclient.Session object.
          type: string
          default: "hmc-userid"
        password:
          description: >-
            "password" parameter for the zhmcclient.Session object.
          type: string
          default: "hmc-password"
        session_id:
          description: >-
            "session_id" parameter for the zhmcclient.Session object.
          type: string
          default: "hmc-session-id"
    hmc_interactions:
      description: List of HMC interactions for this testcase.
      type: array
      items:
        description: >-
          A single HMC interaction with expected HTTP request and HTTP response
          to be returned.
        type: object
        additionalProperties: false
        required:
          - http_request
          - http_response
        properties:
          http_request:
            description: >-
              The expected HTTP request, for being checked in the test function.
            type: object
            additionalProperties: false
            required:
              - method
              - uri
            properties:
              method:
                description: The HTTP method in the request.
                type: string
                enum:
                  - GET
                  - PUT
                  - POST
                  - DELETE
              uri:
                description: >-
                  The canonical URI of the HMC resource in the request, for
                  being validated in the test.
                  If omitted, the request URI is not validated in the test.
                type: string
                format: uri
              headers:
                description: >-
                  The HTTP header fields in the request that should be validated
                  in the test.
                  Key is the header name, and value (string) is the header value.
                  Header fields not specified are not validated in the test.
                  If omitted, no header fields are validated in the test.
                type: object
              body:
                description: >-
                  The HTTP body in the request for being validated in the test.
                  If this property is specified as a YAML object, the actual
                  body is parsed as JSON and the validation happens at the
                  object level.
                  If this property is specified as a string, the validation
                  happens at the string level exactly as specified.
                type:
                  - string
                  - object
          http_response:
            description: >-
              The HTTP response to be returned to the zhmcclient code, or
              a requests exception to be raised.
            type: object
            additionalProperties: false
            properties:
              status:
                description: >-
                  The HTTP status code in the response.
                  Mutually exclusive with "callback", and one of them is required.
                type: integer
              headers:
                description: >-
                  The HTTP header fields in the response.
                  Key is the header name, and value (string) is the header value.
                  If omitted, no headers will be in the response.
                  Not permitted when "callback" is specified.
                type: object
              body:
                description: >-
                  The HTTP body in the response.
                  If this property is specified as a YAML object, it is
                  serialized into JSON and then used for the response body.
                  If this property is specified as a string, the string is
                  used for the response body exactly as specified.
                  If omitted, the response body will be unset.
                  Not permitted when "callback" is specified.
                type:
                  - string
                  - object
              callback:
                description: >-
                  A requests_mock callback function.
                  A requests_mock callback function either defines the HTTP
                  response data or raises an exception that appears to the
                  zhmcclient code to come from the "requests" package.
                  The string is the name of a static function in class
                  ResponseCallbacks in conftest.py.
                  Mutually exclusive with "status", and one of them is required.
                type: string
